#! /usr/bin/python
"""
Schedules a job to reset individual counters of relayed mails to 0. This would make sure each spammer finds spamPot relaying everyday
"""
import datetime
import os, time, sys
from apscheduler.scheduler import Scheduler
#import spamConfig
import MySQLdb as mdb

# Start the scheduler
sched = Scheduler()
sched.start()

conn = None

def dbConnect():
  """
  DB connectionn parameters
  """
  #conn = None
  
  #now = datetime.datetime.now()
     
  try:
    conn = mdb.connect (host = "192.168.7.53",
			user = "root",
			passwd = "password",
			db = "spamPot09252012",
			charset='utf8',
			use_unicode = True)
    conn.autocommit(True)						# This is needed for storage engine InnoDB (for foreign keys). It won't save values in tables until commited
    cursor = conn.cursor()
    return cursor
    
  except mdb.Error, e:
    print("[-] Error - %d: %s" % (e.args[0], e.args[1]))
    sys.exit(1)


def reset_counter():
  exeSql = dbConnect()
  
  counters1 = "UPDATE relay SET relay.relayCounter = 0"
  
      
  try:
    exeSql.execute(counters1)
    print "Reseted counters successfully at (1 hours interval): ", datetime.datetime.now()
    
  except mdb.Error, e:
    print("[-] Error (spamScheduler - counters) - %d: %s" % (e.args[0], e.args[1]))
    sys.exit()

if __name__ == '__main__':
  print "ShivaScheduler started at (1 hour interval): ", datetime.datetime.now()
  sched.add_interval_job(reset_counter, hours=1)

  while 1:
    time.sleep(1000)
