#!/usr/bin/env python

import logging
import server
import shutil
import datetime

import MySQLdb as mdb

import shivatacklequeue
import shivaconfig


def main(mailFields, key, exeSql, msgMailRequest):
    logging.info("Inside shivaaddnewrecord Module.")
    records = server.QueueReceiver.records
    source = shivaconfig.queuePath + key
    filename = mailFields['s_id'] + "-" + key
    destination = '/path/to/dumps/raw/' + filename

    logging.info("[+]shivaaddnewrecord Module: Trying to dump raw mail into the local directory.")
    shutil.copy2(source, destination) #  shutil.copy2() copies the meta-data too

    newRecord = {'headers':mailFields['headers'], 'to':mailFields['to'], 'from':mailFields['from'], 'subject':mailFields['subject'], 'date':mailFields['date'], 'firstSeen':mailFields['firstSeen'], 'lastSeen':mailFields['lastSeen'], 'firstRelayed':mailFields['firstRelayed'], 'lastRelayed':mailFields['lastRelayed'], 'sourceIP':mailFields['sourceIP'], 'sensorID':mailFields['sensorID'], 'text':mailFields['text'], 'html':mailFields['html'], 'inlineFileName':mailFields['inlineFileName'], 'inlineFile':mailFields['inlineFile'], 'inlineFileMd5':mailFields['inlineFileMd5'], 'attachmentFileName': mailFields['attachmentFileName'], 'attachmentFile':mailFields['attachmentFile'], 'attachmentFileMd5':mailFields['attachmentFileMd5'], 'links':mailFields['links'], 'ssdeep':mailFields['ssdeep'], 's_id':mailFields['s_id'], 'len':mailFields['len'], 'counter':1, 'relayed' : 0}

    if int(server.QueueReceiver.totalRelay) <= shivaconfig.relaycounter:
        logging.info("[+]shivaaddnewrecord Module: Relay counter has not reached limit yet. I shall relay this.")

        shivatacklequeue.process_message(msgMailRequest)
        newRecord['relayed'] += 1
        server.QueueReceiver.totalRelay += 1

    else:
        logging.critical("[+]shivaaddnewrecord Module: Limit for this hour has been reached. Not relaying.")


    logging.info("[+]shivaaddnewrecord Module: Adding spam's detail into global dictionary.")

    records.insert(0, newRecord) #Inserting new record at the first position so that the same types of mail following it can differentiated in a fast manner.
    del newRecord
