
"""
This file contains global variables used in various customised files.
Any change needed shall be made here and it would get reflected in customised files

"""
import server
import os, sys, logging
import MySQLdb as mdb
import shutil
import smtplib
#import time, datetime
#import spamConfig

dataBaseName = 'spamPot09252012'

# PATH for ShivaReceiver (receiver) server to dump mails into and for ShivaAnalyser (analyser) to retrieve mails from
queuePath = '/path/to/Shiva/ShivaReceiver/iReceiver/run/queue/new/'

# PATH for those spam samples which could not be handled by spamPot Analyser properly
devilPath = '/path/to/Shiva/ShivaAnalyzer/iAnalyzer/ShivaDistortedSamples/'

# The maximum number of mails to be relayed in xx number of minutes/hours. ShivaScheduler flushes it to value 0 depending on scheduler cycle
relayCounter = 150
# The maximum number of mails to be relayed per combo (from + subject) basis i.e. for one particual spam. ShivaScheduler flushes it to value 0 depending on scheduler cycle
individualRelayCounter = 5


def sendErrorNotificationMail(msgMailRequest):
  sender = 'Shiva@somedomain.com'
  receivers = ['yourname@gmail.com']
  
  
  message = """From: ShivaTrade <Shiva@somedomain.com>
To: You <yourname@gmail.com>
MIME-Version: 1.0
Content-type: text/html
Subject: Master! There is an error!

<b>Though error has been handled, it needs your attention. Please check log files.</b>
"""
  try:
    smtpObj = smtplib.SMTP('127.0.0.1', '2500')
    smtpObj.sendmail(sender, receivers, message)         
    logging.critical("Error Notification Mail Successfully Sent")
  except smtplib.SMTPException:
    logging.critical("Error: unable to send error notification email")

def sendRelayNotificationMail():
  sender = 'Shiva@somedomain.com'
  receivers = ['yourname@gmail.com']  
  
  message = """From: ShivaTrade <Shiva@somedomain.com>
To: b0nd <yourname@gmail.com>
MIME-Version: 1.0
Content-type: text/html
Subject: mail arrived

<b>A mail has been sent successfully</b>
"""
  try:
    smtpObj = smtplib.SMTP('127.0.0.1', '2500')
    smtpObj.sendmail(sender, receivers, message)         
    logging.critical("Relay Notification Mail Successfully Sent")
  except smtplib.SMTPException:
    logging.critical("Error: unable to send relay notification email")


def dbConnect():
  """
  DB connectionn parameters
  """
  conn = None
  
  try:
    conn = mdb.connect (host = "192.168.7.53",
			user = "root",
			passwd = "password",
			db = "spamPot09252012",
			charset='utf8',
			use_unicode = True)
    conn.autocommit(True)						# This is needed for storage engine InnoDB (for foreign keys). It won't save values in tables until commited
    cursor = conn.cursor()
    return cursor
    
  except mdb.Error, e:
    logging.critical("[-] Error (Module spamConfig.py) - %d: %s" % (e.args[0], e.args[1]))
    sendErrorNotificationMail(1)	# passing any random value to it
    sys.exit(1)
    


def errorHandling(key, msgMailRequest):
  """
  Copies the troublesome spam to different folder and removes it from queue
  """
  logging.critical("\n\t\t\t************************* [-] Error!!! *************************")
  logging.critical("Copying spam file to distortedSamples directory before moving it out of queue")
  shutil.copyfile(queuePath + key, devilPath + key)
  sendErrorNotificationMail(msgMailRequest)
