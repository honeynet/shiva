 
"""
This module determines whether to relay or not

Combo = From + Subject + Date, (or combination of any fields) and is determined in ShivaMailParser module

Any new spam would fall under two broad categories:
  1. New Combo
  2. Old Combo

If New Combo:
> Dump spam into DB (spam table)
> Increase Total Counter of spams in spamPot.spam.totalCounter
> Make decision on basis of "Relay Counter (RC) for the day" whether to relay or not. e.g if RC<100 -> Relay, else don't relay. Relay counter = Sum (individual counters in relay table)
> Increment individual counter IC in relay table if relayed
> Remove message from QueueReceiver

If Old Combo:
> Check if any new attachment has come
> If yes - save that attachment, if no - don't save
> Check if new links have come. If yes, save them, else don't
> In both cases, increase Total Counter (TC) in spamPot.spam.totalCounter
> Make decision on basis of "Relay Counter" (RC) and Individual Counter (IC) - if (IC < 10 && RC < 100) - Relay, if [(IC = 10 && RC < 100) || if (IC < 10 && RC = 100)] - Don't relay
> If relayed - increment IC in relay table
> Remove message from QueueReceiver
"""
import server
import os, sys, logging
import MySQLdb as mdb
import ShivaConfig, ShivaTackleQueue, ShivaNewSpam, ShivaOldSpam
import time, datetime

#mailFields = {'to':'', 'from':'', 'subject':'', 'date':'', 'text':'', 'html':'', 'inlineFileName':[], 'inlineFile':[], 'inlineFileMd5':[], 'attachmentFileName':[], 'attachmentFile':[], 'attachmentFileMd5':[], 'links':[]}

queuePath = ShivaConfig.queuePath

def relay(mailFields, key, msgMailRequest, exeSql):
  """
  It does the decision making part - which spam to relay, which attachment to save, client notifications etc.
  """
  
  status = 0							# status = 0 (new combo), i.e. "from" + "subject" + "date" combo is not in DB, so consider it as new combo and relay if counters allow
								# status = 1 (old combo), i.e. "from" + "subject" + "date" combo is already there but check if new md5 attachment has come. If yes, save it
  

  checkData = "SELECT spam.id FROM spam WHERE spam.id = '"+ str(mailFields['spam_id'])+"'"
    
  try:
    exeSql.execute(checkData)

    if len(exeSql.fetchall()) >= 1:
      status = 1
    
  except mdb.Error, e:
    logging.critical("[-] Error (ShivaMailRelayer - retriving combos from DB) - %d: %s" % (e.args[0], e.args[1]))
    ShivaConfig.errorHandling(key, msgMailRequest)
    return None

  if status == 1:						# i.e. it's old combo
    logging.critical("status = 1, i.e. Old Combo - found in DB")
    ShivaOldSpam.pushIntoDB(mailFields, key, msgMailRequest, exeSql)

  else:
    logging.critical("status = 0, i.e. New Combo - from and subject not found in DB")
    ShivaNewSpam.pushIntoDB(mailFields, key, msgMailRequest, exeSql)     
